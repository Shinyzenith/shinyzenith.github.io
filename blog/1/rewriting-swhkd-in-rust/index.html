<!doctype html><html><head><meta charset=utf-8><title>Rewriting swhkd in rust! · Shinyzenith</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical href=https://aakash.is-a.dev/blog/1/rewriting-swhkd-in-rust/><meta name=author content="Aakash Sen Sharma"><link rel=stylesheet href=https://aakash.is-a.dev/node_modules/normalize.css/normalize.css><link rel=stylesheet href=https://aakash.is-a.dev/node_modules/firacode/distr/fira_code.css><link rel=stylesheet href=https://aakash.is-a.dev/css/nanum-gothic-coding.css><link rel=stylesheet href=https://aakash.is-a.dev/css/style.css></head><body><header><h1>空</h1></header><div id=main><nav><a href=https://aakash.is-a.dev/>Home</a> &#183;
<a href=https://aakash.is-a.dev/blog>Blog</a> &#183;
<a rel=me href=https://aakash.is-a.dev/about>About</a> &#183;
<a rel=me href=https://github.com/shinyzenith>GitHub</a> &#183;
<a rel=me href=https://fosstodon.org/@shinyzenith>Mastodon</a></nav><main><article><header><h1>Rewriting swhkd in rust!</h1></header><hr><p>Hi all! It&rsquo;s high time I put this domain purchase to use and uploaded my first blog.</p><p>I started a project called swhkd a few weeks back which stands for the <strong>S</strong>imple <strong>W</strong>ayland <strong>H</strong>ot<strong>K</strong>ey <strong>D</strong>aemon.</p><p>Swhkd is a drop in replacement for the popular X11 utility <a href=https://github.com/baskerville/sxhkd>sxhkd</a>, which is a hotkey daemon.
Don&rsquo;t let the name fool you, swhkd is compatible with X11, WayLand, and TTY.</p><p>Initially I wrote a python prototype which worked well for a concept but was a memory hog, consuming upto 19Mb for just printing the device key events.
I was initially considering zig or go for the rewrite but then I decided to give the RIIR ( rewrite it in rust ) meme a try.</p><p>Rust definitely lived up to it&rsquo;s name. <a href=https://github.com/waycrate/swhkd/pull/7>After the rewrite</a> the code isn&rsquo;t too hard to read and it&rsquo;s really
performant ( 4kb memory consumption for the entire execution ). However rust&rsquo;s memory management model of ownership and borrowing did take me quite a while to
get comfortable with.</p><p>Swhkd uses the <a href=https://crates.io/crates/evdev>evdev</a> crate for getting all keyboard events from the kernel directly. This gives us a uniform protocol to acccess
keyevents irrelavant of the display server, unlike sxhkd&rsquo;s X11 direct key event grab ( one of the security risks of using X11 ).</p><p>For swhkd to read the key events the user invoking must be in the input group, which is inherently insecure as all programs running as said user can directly read the
entire key event stream from the kernel ( making wayland the same as X11&mldr; ).
This problem is solved by making a polkit policy file for swhkd which allows users to run swhkd as root without a password.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE policyconfig PUBLIC &#34;-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN&#34; &#34;http://www.freedesktop.org/standards/PolicyKit/1/policyconfig.dtd&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;policyconfig&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;action</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;com.github.swhkd.pkexec&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;message&gt;</span>Authentication is required to run Simple Wayland Hotkey Daemon<span style=color:#f92672>&lt;/message&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;defaults&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;allow_any&gt;</span>no<span style=color:#f92672>&lt;/allow_any&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;allow_inactive&gt;</span>no<span style=color:#f92672>&lt;/allow_inactive&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;allow_active&gt;</span>yes<span style=color:#f92672>&lt;/allow_active&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/defaults&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;annotate</span> <span style=color:#a6e22e>key=</span><span style=color:#e6db74>&#34;org.freedesktop.policykit.exec.path&#34;</span><span style=color:#f92672>&gt;</span>/usr/bin/swhkd<span style=color:#f92672>&lt;/annotate&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/action&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/policyconfig&gt;</span>
</span></span></code></pre></div><p>Currently I&rsquo;m <a href=https://github.com/waycrate/swhkd/pull/10>writing</a> the client to receive the shell commands. On every key trigger the daemon should
send a shell command back to the client using UNIX socket IPC according to the keybind callback function.</p><p>More updates will be available soon™.</p></article></main><footer>© 2023 Aakash Sen Sharma
<a rel=license href=http://creativecommons.org/licenses/by/3.0/us/><img alt="Creative Commons License" src=https://i.creativecommons.org/l/by/3.0/us/80x15.png></a></footer></div></body></html>